---
author: Ryuichi Umehara
pubDatetime: 2023-01-30T15:57:52.737Z
title: Cognitoを用いたSPA x backend API の認証&認可 設計
postSlug: cognito
featured: true
ogImage: https://user-images.githubusercontent.com/53733092/215771435-25408246-2309-4f8b-a781-1f3d93bdf0ec.png
tags:
  - release
description: Cognitoを用いたSPAの認証&認可の設計方法について説明します．
---

こんにちは．
今日はAmazon Cognitoを用いたSingle Page Application (SPA) の認証 and 認可の設計方法についてご説明します．


## Table of contents

- 認証と認可の違い
- Cognitoにおける認証 and 認可の設計方法の勘所

## 認証と認可の違い

似た漢字なので両者を混同して使っている人も多いかもしれませんが，両者の意味は全く異なります．

認証は，そのユーザーが誰なのかを保証することを言います．

一方で認可はユーザーにどの権限を付与するかを判定することを言います．

## Cognitoにおける認証 and 認可の設計方法の勘所

Cognitoでは認証と認可を実装することができます．

AWSリソースを操作するような権限を付与するために，ユーザーのグループを分けることで認可機能を実装することができます．

しかし，今回はSPAとBackEndのAPIにおいて，認証と認可をどのように設計していくべきかをご説明します．

### 基本的にCognitoには認証のみを持たせるべき

基本的にCognitoには認証機能のみを持たせるべきです．

以下その理由を説明していきます．

Cognitoの初期設定時にはユーザーにどのようなプロパティを持たせるかを指定することができます．

たとえば，ユーザーにはユーザー登録の際に，ユーザー名やニックネーム，電話番号などの情報を入力してもらい，Cognito上でそれらの情報を保存することができます．

よって，たとえば，電話番号とPasswordで認証を行うといったことが実現できます．

このプロパティはCognitoによってデフォルトで準備されているものから，実際に使用する項目を選ぶこともできますし，開発者自身がカスタムプロパティを設定することができます．

### カスタムプロパティでは認可機能を実装できるのか

このカスタムプロパティを使用すると権限を管理することもできそうですが，1つ大きな落とし穴があります．

それは，このプロパティというのは後から追加したり変更することができないということです．

例えば，あるアプリケーションを保守運用する場合を考えます．

権限管理として，今まではCognito上で設定していた`role`プロパティを使って，`role`が`admin`の人には管理者権限が与えられていたとします．

しかし，次により複雑な条件で認可を実装しようとした時に，cognitoには新たにプロパティを設定することができないので，新たに認証プロバイダーを作成し移行したり，DBにユーザーテーブルを作成して，新たなプロパティを追加することで対処する必要があります．

こうなってしまうと，cognitoとDBでユーザー情報を二重に管理する必要が出てきます．

よって，Cognitoを使用する際には，Cognitoに保存する情報は認証で使用するメールアドレスや電話番号のみにしておき，権限などを含んだユーザーの大抵の情報はもとからDBに保存しておき，後からマイグレーションなどの方法で変更ができる状態にしておくことが望ましいです．

### ユーザー情報の二重管理の影響を極力無くす

Cognitoに必要最小限の情報だけを持たせるメリットは，権限管理の実装を柔軟にする以外にもあります．

それは，ユーザー情報の二重管理の影響を極力減らせることです．

ユーザーに関する情報はCognitoとDBの二箇所に存在しています．

もしも，重複した情報が存在する場合は，両者で同期を行う必要があります．またCognitoが持つ情報が多い場合は，どのプロパティがCognitoで管理されており，どのプロパティがDBで管理されているのかを把握することが，開発を進めていくと困難になっていきます．

しかし，Cognitoに持たせる情報を必要最低限にすることで，開発者はCognito ⇄ DB間の情報の同期を最低限に保つことができますし，ユーザーのプロパティはDBだけ見れば良いということになるので開発により専念することができます．

### ユーザー作成をどこで行うべきか

しかし，そうすると次の問題としてどこでユーザー作成を行うべきかという問題が発生します．

CognitoはCognito自身が，サインアップ画面やログイン画面，パスワード変更画面などを自動でホスティングしてくれるため，非常に便利です

しかし，この場合ユーザーの情報はCognito上にのみ存在することになってしまうので，ユーザーには後からDBに保存する追加の情報を入力してもらう必要があります．

ここはtoC向けのアプリケーションかtoB向けのアプリケーションかで大きく方針がわかれそうです．

toC向けのアプリケーションでは，ユーザー登録までの障壁をなるべく低くすることで，ユーザーの離脱を防ぐことができるかもしれません．

この場合は，

1. Cognitoでユーザー登録
2. SPA上で機能を使用する前に追加のユーザー情報を入力してもらいDBに保存

という流れになることが多いと思います．

一方でtoB向けのアプリケーションでは，一般的に管理者がユーザーを作成する必要があります．この場合は

1. SPA上でユーザー招待or作成のタイミングでユーザー情報の入力
2. API側からCognitoに向けてユーザー作成のリクエストを投げる

という流れになります．

これらのフローでは作成するコンポーネントやエンドポイントが大きく変わるので注意が必要です．

